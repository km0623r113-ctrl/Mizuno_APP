<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãŠå°é£ã„å¸³</title>
    <!-- ãƒ‡ã‚¶ã‚¤ãƒ³ç”¨ (Tailwind CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ãƒ­ã‚¸ãƒƒã‚¯ç”¨ (Vue.js 3) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        /* ãƒ™ãƒ¼ã‚¹è¨­å®š */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
            padding-bottom: 80px;
        }
        /* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .simple-card {
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .card-header {
            padding: 12px 16px;
            border-bottom: 1px solid #f3f4f6;
            font-weight: bold;
            color: #4b5563;
        }
        .card-body { padding: 16px; }

        /* ãƒ†ãƒ¼ãƒ–ãƒ« */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .history-table th { text-align: left; padding: 8px; color: #9ca3af; font-size: 12px; }
        .history-table td { padding: 10px 8px; border-bottom: 1px solid #f3f4f6; }
        .history-table tr:last-child td { border-bottom: none; }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ã®èª¿æ•´ */
        input[type=number]::-webkit-inner-spin-button { opacity: 1; }
        button:active { opacity: 0.7; transform: scale(0.98); }
    </style>
</head>
<body>

<div id="app" class="max-w-md mx-auto p-4 md:max-w-2xl">
    
    <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
    <header class="mb-5 text-center pt-2">
        <h1 class="text-2xl font-extrabold text-gray-800 tracking-tight">ğŸ’° ãŠå°é£ã„å¸³</h1>
    </header>

    <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
    <div class="flex bg-white rounded-xl p-1 shadow-sm mb-6">
        <button @click="currentView = 'input'" 
            :class="['flex-1 py-2 rounded-lg text-sm font-bold transition', currentView === 'input' ? 'bg-blue-100 text-blue-600' : 'text-gray-500']">
            ğŸ“ å…¥åŠ›
        </button>
        <button @click="currentView = 'list'" 
            :class="['flex-1 py-2 rounded-lg text-sm font-bold transition', currentView === 'list' ? 'bg-purple-100 text-purple-600' : 'text-gray-500']">
            ğŸ† çµæœ
        </button>
    </div>

    <!-- =========================
         ã€1ã€‘å…¥åŠ›ç”»é¢
         ========================= -->
    <div v-show="currentView === 'input'">
        
        <!-- å­ä¾›é¸æŠãƒœã‚¿ãƒ³ -->
        <div class="flex space-x-2 mb-6 overflow-x-auto pb-1">
            <button v-for="child in children" :key="child.id"
                @click="selectedChildId = child.id"
                :class="['flex-1 py-3 px-2 rounded-xl border-2 font-bold shadow-sm transition whitespace-nowrap', 
                selectedChildId === child.id ? 'bg-gray-800 text-white border-gray-800' : 'bg-white text-gray-500 border-gray-200']">
                <span :style="{ color: selectedChildId === child.id ? child.color : '#ccc' }">â—</span> {{ child.name }}
            </button>
        </div>

        <!-- æ—¥æ¬¡å…¥åŠ›ã‚¨ãƒªã‚¢ -->
        <div class="simple-card">
            <div class="card-header flex justify-between items-center bg-blue-50">
                <span class="text-blue-800">ğŸ“… ä»Šæ—¥ã®è¨˜éŒ²</span>
                <input type="date" v-model="inputDate" class="bg-white border rounded px-2 py-1 text-xs font-bold text-gray-700">
            </div>
            <div class="card-body space-y-4">
                <div v-for="chore in dailyChores" :key="chore.id">
                    <div class="flex items-center justify-between mb-1">
                        <div class="flex items-center">
                            <input type="checkbox" :id="'chk-'+chore.id" v-model="entryData[chore.id].checked" class="w-6 h-6 border-2 border-gray-300 rounded text-blue-600 focus:ring-0">
                            <label :for="'chk-'+chore.id" class="ml-3 font-bold text-gray-800 text-lg">{{ chore.label }}</label>
                        </div>
                        <div class="flex items-center bg-gray-100 rounded px-2">
                            <input type="number" v-model.number="entryData[chore.id].price" step="10" min="0" 
                                class="w-16 py-1 text-right bg-transparent font-bold text-gray-700 outline-none">
                            <span class="text-xs text-gray-500">å††</span>
                        </div>
                    </div>
                    <!-- ãƒã‚§ãƒƒã‚¯æ™‚ã®ã¿å‚™è€ƒæ¬„ -->
                    <input v-if="entryData[chore.id].checked" type="text" v-model="entryData[chore.id].note" placeholder="ãƒ¡ãƒ¢ (ä»»æ„)" 
                        class="w-full p-2 text-xs border rounded bg-yellow-50 mt-1">
                </div>
            </div>
            <div class="p-4 pt-0">
                <button @click="saveDailyRecords" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow hover:bg-blue-700 transition">
                    ä¿å­˜ã™ã‚‹
                </button>
            </div>
        </div>

        <!-- æœˆé¡å…¥åŠ›ã‚¨ãƒªã‚¢ -->
        <div class="simple-card border-l-4 border-orange-400">
            <div class="card-header flex justify-between items-center bg-orange-50">
                <span class="text-orange-800">ğŸ—“ï¸ æœˆé¡ãŠæ‰‹ä¼ã„</span>
                <input type="month" v-model="inputMonth" class="bg-white border rounded px-2 py-1 text-xs font-bold text-gray-700">
            </div>
            <div class="card-body">
                <div class="flex justify-between items-center mb-3">
                    <div class="font-bold text-orange-900 text-lg">ğŸ‘¶ ç‘ äººã®ãŠä¸–è©±</div>
                    <div class="flex items-center bg-white border border-orange-200 rounded px-2 py-1">
                        <input type="number" v-model.number="monthlyData.price" step="100" min="0" 
                            class="w-20 text-right font-bold text-orange-600 text-lg outline-none">
                        <span class="text-xs text-orange-400 ml-1">å††</span>
                    </div>
                </div>
                <textarea v-model="monthlyData.note" rows="2" placeholder="ä»Šæœˆã®ãŒã‚“ã°ã‚Šãƒ¡ãƒ¢" class="w-full p-2 border rounded text-sm bg-gray-50 mb-2"></textarea>
                
                <div v-if="isMonthlyRegistered" class="bg-red-50 text-red-600 text-xs font-bold p-2 rounded mb-2 text-center">
                    âš ï¸ {{ formatMonth(inputMonth) }}åˆ†ã¯ç™»éŒ²æ¸ˆã¿ã§ã™ (ä¸Šæ›¸ãã—ã¾ã™)
                </div>

                <button @click="saveMonthlyRecord" class="w-full bg-orange-500 text-white font-bold py-2 rounded-lg shadow hover:bg-orange-600 transition">
                    {{ formatMonth(inputMonth) }}åˆ†ã‚’æ±ºå®š
                </button>
            </div>
        </div>
    </div>

    <!-- =========================
         ã€2ã€‘çµæœç”»é¢ (ä¸€è¦§è¡¨ & åˆ†æ)
         ========================= -->
    <div v-show="currentView === 'list'">

        <!-- æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ -->
        <div class="flex justify-center mb-6 bg-white p-1 rounded-full shadow-sm mx-2">
            <button v-for="t in filterTypes" :key="t.value" 
                @click="filterType = t.value"
                :class="['flex-1 py-1.5 rounded-full text-xs font-bold transition', 
                filterType === t.value ? 'bg-gray-800 text-white shadow' : 'text-gray-500 hover:bg-gray-50']">
                {{ t.label }}
            </button>
        </div>

        <!-- â‘  å­ä¾›ã”ã¨ã®é›†è¨ˆã‚«ãƒ¼ãƒ‰ (å†…è¨³ä»˜ã) -->
        <div v-for="child in children" :key="child.id" class="simple-card">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†: åå‰ã¨åˆè¨ˆé‡‘é¡ -->
            <div class="p-4 flex justify-between items-center border-b border-gray-100" :style="{ backgroundColor: child.bgColor }">
                <div class="flex items-center">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3 shadow-sm" :style="{ backgroundColor: child.color }">
                        {{ child.name.charAt(0) }}
                    </div>
                    <span class="font-bold text-gray-700">{{ child.name }}</span>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-black text-gray-800">Â¥{{ getFilteredTotalAmount(child.id).toLocaleString() }}</div>
                    <div class="text-xs text-gray-500 font-bold">{{ getFilteredTotalCount(child.id) }}å›ã®ãŠæ‰‹ä¼ã„</div>
                </div>
            </div>

            <!-- ãƒœãƒ‡ã‚£éƒ¨åˆ†: å†…è¨³ãƒªã‚¹ãƒˆ -->
            <div class="px-4 py-3 bg-white">
                <div v-if="getBreakdown(child.id).length === 0" class="text-xs text-gray-400 text-center py-2">ãƒ‡ãƒ¼ã‚¿ãªã—</div>
                <div v-else class="space-y-2">
                    <div v-for="item in getBreakdown(child.id)" :key="item.choreId" class="flex justify-between items-center text-sm">
                        <div class="flex items-center">
                            <span class="text-gray-600 font-medium">{{ item.label }}</span>
                            <span class="ml-2 text-xs bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded-full">Ã—{{ item.count }}</span>
                        </div>
                        <div class="font-bold text-gray-700">Â¥{{ item.amount.toLocaleString() }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- â‘¡ è©³ç´°å±¥æ­´ãƒªã‚¹ãƒˆ -->
        <div class="simple-card">
            <div class="card-header bg-gray-50">ğŸ“‹ è©³ç´°å±¥æ­´</div>
            <div v-if="filteredRecords.length === 0" class="p-6 text-center text-gray-400 text-sm">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
            
            <table v-else class="history-table">
                <thead>
                    <tr>
                        <th class="w-16">æ—¥ä»˜</th>
                        <th>èª°ãŒ / å†…å®¹</th>
                        <th class="text-right">é‡‘é¡</th>
                        <th class="w-8"></th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="rec in filteredRecords" :key="rec.id">
                        <td class="align-top">
                            <div class="text-xs font-bold text-gray-500">{{ rec.date.slice(5).replace('-','/') }}</div>
                        </td>
                        <td>
                            <div class="flex items-center mb-0.5">
                                <span class="text-[10px] font-bold px-1.5 py-0.5 rounded text-white mr-2" :style="{ backgroundColor: getChildColor(rec.childId) }">
                                    {{ getChildName(rec.childId) }}
                                </span>
                                <span class="text-sm font-bold text-gray-800">{{ getChoreLabel(rec.choreId) }}</span>
                            </div>
                            <div v-if="rec.note" class="text-xs text-gray-400 pl-1">ğŸ“ {{ rec.note }}</div>
                        </td>
                        <td class="text-right align-top font-bold text-gray-700">Â¥{{ rec.price }}</td>
                        <td class="text-center align-top">
                            <button @click="deleteRecord(rec)" class="text-gray-300 hover:text-red-500 text-lg leading-none">Ã—</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            // --- ãƒ‡ãƒ¼ã‚¿å®šç¾© ---
            const children = ref([
                { id: 1, name: 'å‡›äºº', color: '#3b82f6', bgColor: '#eff6ff' }, // é’
                { id: 2, name: 'ä½‘å’²', color: '#ec4899', bgColor: '#fdf2f8' }, // ãƒ”ãƒ³ã‚¯
                { id: 3, name: 'ç¢§äºº', color: '#10b981', bgColor: '#ecfdf5' }  // ç·‘
            ]);

            const dailyChores = [
                { id: 'vacuum', label: 'æƒé™¤æ©Ÿ', defaultPrice: 50 },
                { id: 'dishes', label: 'ãŠçš¿æ´—ã„', defaultPrice: 30 },
                { id: 'bath', label: 'ãŠé¢¨å‘‚æ´—ã„', defaultPrice: 50 },
                { id: 'helper', label: 'ãŠãŸã™ã‘ãƒãƒ³', defaultPrice: 10 }
            ];

            const monthlyChores = [
                { id: 'ruto_care', label: 'ç‘ äººã®ãŠä¸–è©±', defaultPrice: 500 }
            ];

            const allChores = [...dailyChores, ...monthlyChores];
            const records = ref([]);

            // --- çŠ¶æ…‹ ---
            const currentView = ref('input');
            const selectedChildId = ref(1);
            const inputDate = ref(new Date().toISOString().split('T')[0]);
            const entryData = ref({});
            const inputMonth = ref(new Date().toISOString().slice(0, 7));
            const monthlyData = ref({ price: 500, note: '' });
            
            // ãƒ•ã‚£ãƒ«ã‚¿è¨­å®š
            const filterType = ref('month'); 
            const filterTypes = [
                { value: 'all', label: 'å…¨æœŸé–“' },
                { value: 'year', label: 'ä»Šå¹´' },
                { value: 'month', label: 'ä»Šæœˆ' },
                { value: 'week', label: 'ä»Šé€±' },
            ];

            // --- åˆæœŸåŒ– ---
            const resetEntryData = () => {
                dailyChores.forEach(c => {
                    entryData.value[c.id] = { checked: false, price: c.defaultPrice, note: '' };
                });
            };
            resetEntryData();

            // --- ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ---
            const loadFromStorage = () => {
                const saved = localStorage.getItem('okozukai_simple_v1');
                if (saved) {
                    try { records.value = JSON.parse(saved); } catch(e) {}
                }
            };
            const saveToStorage = () => {
                localStorage.setItem('okozukai_simple_v1', JSON.stringify(records.value));
            };
            onMounted(() => loadFromStorage());

            // --- è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---
            const getChildName = (id) => children.value.find(c => c.id === id)?.name;
            const getChildColor = (id) => children.value.find(c => c.id === id)?.color;
            const getChoreLabel = (id) => allChores.find(c => c.id === id)?.label;
            const formatMonth = (yyyy_mm) => { const [y, m] = yyyy_mm.split('-'); return `${parseInt(m)}æœˆ`; };

            const isMonthlyRegistered = computed(() => {
                return records.value.some(r => r.childId === selectedChildId.value && r.choreId === 'ruto_care' && r.date.startsWith(inputMonth.value));
            });

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½
            const filteredRecords = computed(() => {
                let recs = [...records.value];
                const now = new Date();
                
                recs = recs.filter(r => {
                    const d = new Date(r.date);
                    
                    if (filterType.value === 'year') {
                        return d.getFullYear() === now.getFullYear();
                    }
                    if (filterType.value === 'month') {
                        return d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth();
                    }
                    if (filterType.value === 'week') {
                        // ä»Šé€±ï¼ˆæ—¥æ›œæ—¥å§‹ã¾ã‚Šã€œä»Šæ—¥ï¼‰
                        const startOfWeek = new Date(now);
                        startOfWeek.setDate(now.getDate() - now.getDay()); // æ—¥æ›œæ—¥ã¸
                        startOfWeek.setHours(0,0,0,0);
                        const recordDate = new Date(r.date);
                        recordDate.setHours(0,0,0,0);
                        return recordDate >= startOfWeek && recordDate <= now;
                    }
                    return true; // all
                });
                
                return recs.sort((a, b) => new Date(b.date) - new Date(a.date));
            });

            // é›†è¨ˆ
            const getFilteredTotalAmount = (childId) => {
                return filteredRecords.value.filter(r => r.childId === childId).reduce((sum, r) => sum + r.price, 0);
            };
            const getFilteredTotalCount = (childId) => {
                return filteredRecords.value.filter(r => r.childId === childId).length;
            };

            // å†…è¨³è¨ˆç®—
            const getBreakdown = (childId) => {
                const childRecs = filteredRecords.value.filter(r => r.childId === childId);
                const map = {};
                
                childRecs.forEach(r => {
                    if (!map[r.choreId]) {
                        map[r.choreId] = { 
                            choreId: r.choreId, 
                            label: getChoreLabel(r.choreId), 
                            count: 0, 
                            amount: 0 
                        };
                    }
                    map[r.choreId].count++;
                    map[r.choreId].amount += r.price;
                });
                
                // é‡‘é¡ãŒé«˜ã„é †ã«ã‚½ãƒ¼ãƒˆ
                return Object.values(map).sort((a, b) => b.amount - a.amount);
            };

            // --- ä¿å­˜ãƒ»å‰Šé™¤ ---
            const saveDailyRecords = () => {
                let savedCount = 0;
                dailyChores.forEach(chore => {
                    const entry = entryData.value[chore.id];
                    if (entry.checked) {
                        records.value.push({
                            id: Date.now() + Math.random(),
                            childId: selectedChildId.value,
                            date: inputDate.value,
                            choreId: chore.id,
                            price: entry.price,
                            note: entry.note
                        });
                        savedCount++;
                    }
                });

                if (savedCount > 0) {
                    saveToStorage();
                    alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
                    dailyChores.forEach(c => {
                        entryData.value[c.id].checked = false;
                        entryData.value[c.id].note = '';
                    });
                } else {
                    alert("ãŠæ‰‹ä¼ã„ã‚’é¸ã‚“ã§ãã ã•ã„");
                }
            };

            const saveMonthlyRecord = () => {
                const saveDate = `${inputMonth.value}-01`;
                const existingIndex = records.value.findIndex(r => r.childId === selectedChildId.value && r.choreId === 'ruto_care' && r.date.startsWith(inputMonth.value));

                if (existingIndex !== -1) {
                    if (!confirm("ä»Šæœˆåˆ†ã¯ã™ã§ã«ç™»éŒ²æ¸ˆã¿ã§ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ")) return;
                    records.value.splice(existingIndex, 1);
                }

                records.value.push({
                    id: Date.now() + Math.random(),
                    childId: selectedChildId.value,
                    date: saveDate,
                    choreId: 'ruto_care',
                    price: monthlyData.value.price,
                    note: monthlyData.value.note
                });
                saveToStorage();
                alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
            };

            const deleteRecord = (target) => {
                if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                    records.value = records.value.filter(r => r.id !== target.id);
                    saveToStorage();
                }
            };

            return {
                children, dailyChores, monthlyChores, currentView,
                selectedChildId, inputDate, entryData, inputMonth, monthlyData, 
                filterType, filterTypes,
                filteredRecords, isMonthlyRegistered,
                getChildName, getChildColor, getChoreLabel, formatMonth,
                getFilteredTotalAmount, getFilteredTotalCount, getBreakdown,
                saveDailyRecords, saveMonthlyRecord, deleteRecord
            };
        }
    }).mount('#app');
</script>

</body>
</html>
