<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ’° ãŠå°é£ã„å¸³ ğŸ’°</title>
    <!-- ã‚¢ã‚¤ã‚³ãƒ³è¨­å®š -->
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Money%20bag/3D/money_bag_3d.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background-color: #f3f4f6; padding-bottom: 80px; }
        .simple-card { background-color: #fff; border-radius: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; overflow: hidden; }
        .card-header { padding: 12px 16px; border-bottom: 1px solid #f3f4f6; font-weight: bold; color: #4b5563; }
        .card-body { padding: 16px; }
        .history-table { width: 100%; font-size: 14px; border-collapse: collapse; }
        .history-table td { padding: 12px 8px; border-bottom: 1px solid #f3f4f6; vertical-align: middle; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        input[type=number]::-webkit-inner-spin-button { opacity: 1; }
        /* ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .custom-select { appearance: none; background-color: white; border: 1px solid #d1d5db; padding: 6px 24px 6px 12px; border-radius: 8px; font-weight: bold; color: #374151; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; }
    </style>
</head>
<body>

<div id="app" class="max-w-md mx-auto p-4 md:max-w-2xl">
    <header class="mb-5 text-center pt-2">
        <h1 class="text-2xl font-extrabold text-gray-800 tracking-tight">ğŸ’° ãŠå°é£ã„å¸³ ğŸ’°</h1>
        <p v-if="loading" class="text-xs text-blue-600 font-bold mt-1 animate-pulse">ğŸ“¡ é€šä¿¡ä¸­...</p>
    </header>

    <!-- ã‚¿ãƒ– -->
    <div class="flex bg-white rounded-xl p-1 shadow-sm mb-6">
        <button @click="currentView = 'input'" :class="['flex-1 py-2 rounded-lg text-sm font-bold transition', currentView === 'input' ? 'bg-blue-100 text-blue-600' : 'text-gray-500']">
            ğŸ“ å…¥åŠ›
        </button>
        <button @click="currentView = 'list'; fetchData();" :class="['flex-1 py-2 rounded-lg text-sm font-bold transition', currentView === 'list' ? 'bg-purple-100 text-purple-600' : 'text-gray-500']">
            ğŸ† çµæœ
        </button>
    </div>

    <!-- å…¥åŠ›ç”»é¢ -->
    <div v-show="currentView === 'input'">
        <!-- å­ä¾›é¸æŠ -->
        <div class="flex space-x-2 mb-6 overflow-x-auto pb-1">
            <button v-for="child in children" :key="child.id" @click="selectedChildId = child.id"
                :class="['flex-1 py-3 px-2 rounded-xl border-2 font-bold shadow-sm whitespace-nowrap transition', selectedChildId === child.id ? 'bg-gray-800 text-white border-gray-800' : 'bg-white text-gray-500 border-gray-200']">
                <span :style="{ color: selectedChildId === child.id ? child.color : '#ccc' }">â—</span> {{ child.name }}
            </button>
        </div>

        <!-- æ—¥æ¬¡å…¥åŠ› -->
        <div class="simple-card">
            <div class="card-header flex justify-between items-center bg-blue-50 text-blue-800">
                <span>ğŸ“… ä»Šæ—¥ã®è¨˜éŒ²</span>
                <input type="date" v-model="inputDate" class="bg-white border rounded px-2 py-1 text-xs font-bold text-gray-700">
            </div>
            <div class="card-body space-y-4">
                <div v-for="chore in dailyChores" :key="chore.id">
                    <div class="flex justify-between items-center mb-1">
                        <div class="flex items-center">
                            <input type="checkbox" :id="'chk-'+chore.id" v-model="entryData[chore.id].checked" class="w-6 h-6 rounded text-blue-600 border-gray-300 focus:ring-0">
                            <label :for="'chk-'+chore.id" class="ml-3 font-bold text-gray-800 text-lg">{{ chore.label }}</label>
                        </div>
                        <div class="flex items-center bg-gray-100 rounded px-2">
                            <input type="number" v-model.number="entryData[chore.id].price" step="10" class="w-16 py-1 text-right bg-transparent font-bold text-gray-700 outline-none">
                            <span class="text-xs text-gray-500">å††</span>
                        </div>
                    </div>
                    <input v-if="entryData[chore.id].checked" type="text" v-model="entryData[chore.id].note" placeholder="ãƒ¡ãƒ¢" class="w-full p-2 text-xs border rounded bg-yellow-50 mt-1">
                </div>
            </div>
            <div class="p-4 pt-0">
                <button @click="saveDailyRecords" :disabled="loading" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow hover:bg-blue-700 disabled:opacity-50 transition">
                    {{ loading ? 'é€ä¿¡ä¸­...' : 'ä¿å­˜ã™ã‚‹' }}
                </button>
            </div>
        </div>

        <!-- æœˆé¡å…¥åŠ› -->
        <div class="simple-card border-l-4 border-orange-400">
            <div class="card-header flex justify-between items-center bg-orange-50 text-orange-800">
                <span>ğŸ—“ï¸ æœˆé¡ãŠæ‰‹ä¼ã„</span>
                <input type="month" v-model="inputMonth" class="bg-white border rounded px-2 py-1 text-xs font-bold text-gray-700">
            </div>
            <div class="card-body">
                <div class="flex justify-between items-center mb-3">
                    <div class="font-bold text-orange-900 text-lg">ğŸ‘¶ ç‘ äººã®ãŠä¸–è©±</div>
                    <div class="flex items-center bg-white border border-orange-200 rounded px-2 py-1">
                        <input type="number" v-model.number="monthlyData.price" step="100" class="w-20 text-right font-bold text-orange-600 text-lg outline-none">
                        <span class="text-xs text-orange-400 ml-1">å††</span>
                    </div>
                </div>
                <textarea v-model="monthlyData.note" rows="2" placeholder="ä»Šæœˆã®ãƒ¡ãƒ¢" class="w-full p-2 border rounded text-sm bg-gray-50 mb-2"></textarea>
                <div v-if="isMonthlyRegistered" class="bg-red-50 text-red-600 text-xs font-bold p-2 rounded mb-2 text-center">âš ï¸ ç™»éŒ²æ¸ˆã¿ã§ã™ (ä¸Šæ›¸ãã—ã¾ã™)</div>
                <button @click="saveMonthlyRecord" :disabled="loading" class="w-full bg-orange-500 text-white font-bold py-2 rounded-lg shadow hover:bg-orange-600 disabled:opacity-50 transition">
                    {{ loading ? 'é€ä¿¡ä¸­...' : formatMonth(inputMonth) + 'åˆ†ã‚’æ±ºå®š' }}
                </button>
            </div>
        </div>
    </div>

    <!-- çµæœç”»é¢ -->
    <div v-show="currentView === 'list'">
        
        <!-- é›†è¨ˆåˆ‡ã‚Šæ›¿ãˆã‚¨ãƒªã‚¢ -->
        <div class="mb-6">
            <!-- 1. ãƒ¢ãƒ¼ãƒ‰é¸æŠãƒœã‚¿ãƒ³ -->
            <div class="flex justify-center bg-white p-1 rounded-full shadow-sm mx-2 mb-3">
                <button v-for="t in filterTypes" :key="t.value" @click="filterType = t.value" 
                    :class="['flex-1 py-1.5 rounded-full text-xs font-bold transition', filterType === t.value ? 'bg-gray-800 text-white shadow' : 'text-gray-500']">
                    {{ t.label }}
                </button>
            </div>

            <!-- 2. å¹´ãƒ»æœˆé¸æŠãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ (å…¨æœŸé–“ä»¥å¤–ã®å ´åˆã«è¡¨ç¤º) -->
            <div v-if="filterType !== 'all'" class="flex justify-center items-center gap-2">
                <!-- å¹´é¸æŠ -->
                <select v-model="targetYear" class="custom-select">
                    <option v-for="y in yearList" :key="y" :value="y">{{ y }}å¹´</option>
                </select>

                <!-- æœˆé¸æŠ (æœˆåˆ¥ãƒ¢ãƒ¼ãƒ‰ã®æ™‚ã ã‘è¡¨ç¤º) -->
                <select v-if="filterType === 'month'" v-model="targetMonth" class="custom-select">
                    <option v-for="m in 12" :key="m" :value="m">{{ m }}æœˆ</option>
                </select>
            </div>
        </div>

        <div v-if="loading" class="loader"></div>

        <div v-else>
            <!-- é›†è¨ˆ -->
            <div v-for="child in children" :key="child.id" class="simple-card">
                <div class="p-4 flex justify-between items-center border-b border-gray-100" :style="{ backgroundColor: child.bgColor }">
                    <div class="flex items-center">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3 shadow-sm" :style="{ backgroundColor: child.color }">{{ child.name.charAt(0) }}</div>
                        <span class="font-bold text-gray-700">{{ child.name }}</span>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-black text-gray-800">Â¥{{ getFilteredTotalAmount(child.id).toLocaleString() }}</div>
                        <div class="text-xs text-gray-500 font-bold">{{ getFilteredTotalCount(child.id) }}å›ã®ãŠæ‰‹ä¼ã„</div>
                    </div>
                </div>
                <div class="px-4 py-3 bg-white">
                    <div v-if="getBreakdown(child.id).length === 0" class="text-xs text-gray-400 text-center py-2">ãƒ‡ãƒ¼ã‚¿ãªã—</div>
                    <div v-else class="space-y-2">
                        <div v-for="item in getBreakdown(child.id)" :key="item.choreId" class="flex justify-between items-center text-sm">
                            <span class="text-gray-600 font-medium">{{ item.label }} <span class="bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded-full text-xs">Ã—{{ item.count }}</span></span>
                            <span class="font-bold text-gray-700">Â¥{{ item.amount.toLocaleString() }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å±¥æ­´ãƒªã‚¹ãƒˆ -->
            <div class="simple-card">
                <div class="card-header bg-gray-50 flex justify-between items-center">
                    <span>ğŸ“‹ è©³ç´°å±¥æ­´ (ä¿®æ­£ãƒ»å‰Šé™¤)</span>
                </div>
                <div v-if="filteredRecords.length === 0" class="p-6 text-center text-gray-400 text-sm">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
                <table v-else class="history-table">
                    <tbody>
                        <tr v-for="rec in filteredRecords" :key="rec.id">
                            <td class="w-16 align-top text-xs font-bold text-gray-500">
                                {{ rec.date.slice(5).replace('-','/') }}
                            </td>
                            <td>
                                <div class="flex items-center mb-1">
                                    <span class="text-[10px] font-bold px-1.5 rounded text-white mr-2" :style="{ backgroundColor: getChildColor(rec.childId) }">{{ getChildName(rec.childId) }}</span>
                                    <span class="text-sm font-bold text-gray-800">{{ getChoreLabel(rec.choreId) }}</span>
                                </div>
                                <div class="font-bold text-gray-600 text-sm mb-1">Â¥{{ rec.price }}</div>
                                <div v-if="rec.note" class="text-xs text-gray-400 bg-gray-50 p-1 rounded inline-block">ğŸ“ {{ rec.note }}</div>
                            </td>
                            <td class="w-16 text-right align-middle">
                                <button @click="deleteRecord(rec)" class="text-xs font-bold bg-red-50 text-red-500 border border-red-200 px-3 py-2 rounded-lg hover:bg-red-100 transition whitespace-nowrap">
                                    ğŸ—‘ï¸ å‰Šé™¤
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    // â˜…â˜…â˜… ã‚ãªãŸã®URLã‚’åŸ‹ã‚è¾¼ã¿æ¸ˆã¿ â˜…â˜…â˜…
    const API_URL = "https://script.google.com/macros/s/AKfycbweL7Q3JboW1fkdssaPM4qcfzD7_kSNJEBT761BqAD38fWWzOJhAisoynfTCjYc6yTbLg/exec"; 
    // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…

    createApp({
        setup() {
            const children = ref([
                { id: 1, name: 'å‡›äºº', color: '#3b82f6', bgColor: '#eff6ff' },
                { id: 2, name: 'ä½‘å’²', color: '#ec4899', bgColor: '#fdf2f8' },
                { id: 3, name: 'ç¢§äºº', color: '#10b981', bgColor: '#ecfdf5' }
            ]);

            const dailyChores = [
                { id: 'vacuum', label: 'æƒé™¤æ©Ÿ', defaultPrice: 50 },
                { id: 'dishes', label: 'ãŠçš¿æ´—ã„', defaultPrice: 30 },
                { id: 'bath', label: 'ãŠé¢¨å‘‚æ´—ã„', defaultPrice: 50 },
                { id: 'kairanban', label: 'å›è¦§æ¿', defaultPrice: 50 },
                { id: 'test100', label: 'ãƒ†ã‚¹ãƒˆ100ç‚¹', defaultPrice: 100 },
                { id: 'helper', label: 'ãŠãŸã™ã‘ãƒãƒ³', defaultPrice: 10 }
            ];
            const monthlyChores = [{ id: 'ruto_care', label: 'æœˆé¡ãŠæ‰‹ä¼ã„', defaultPrice: 500 }];
            const allChores = [...dailyChores, ...monthlyChores];
            
            const records = ref([]);
            const loading = ref(false);
            const currentView = ref('input');
            const selectedChildId = ref(1);
            const inputDate = ref(new Date().toISOString().split('T')[0]);
            const entryData = ref({});
            const inputMonth = ref(new Date().toISOString().slice(0, 7));
            const monthlyData = ref({ price: 500, note: '' });
            
            // â˜… é›†è¨ˆãƒ•ã‚£ãƒ«ã‚¿ç”¨ã®è¨­å®š â˜…
            const filterType = ref('month');
            const targetYear = ref(new Date().getFullYear());
            const targetMonth = ref(new Date().getMonth() + 1);
            // 2024å¹´ã€œ2030å¹´ã¾ã§é¸æŠå¯èƒ½
            const yearList = [2024, 2025, 2026, 2027, 2028, 2029, 2030];

            const filterTypes = [
                { value: 'year', label: 'å¹´åˆ¥' },
                { value: 'month', label: 'æœˆåˆ¥' },
                { value: 'all', label: 'å…¨æœŸé–“' }
            ];

            const resetEntryData = () => {
                dailyChores.forEach(c => entryData.value[c.id] = { checked: false, price: c.defaultPrice, note: '' });
            };
            resetEntryData();

            const fetchData = async () => {
                if(API_URL.includes("ã“ã“ã«")) { alert("URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"); return; }
                loading.value = true;
                try {
                    const res = await fetch(API_URL + "?action=read");
                    const data = await res.json();
                    records.value = data;
                } catch(e) { alert("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: é€šä¿¡ç’°å¢ƒã‚’ç¢ºèªã—ã¦ãã ã•ã„"); }
                loading.value = false;
            };

            const postData = async (payload) => {
                loading.value = true;
                try {
                    await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
                    await new Promise(r => setTimeout(r, 500)); 
                    await fetchData();
                    return true;
                } catch(e) {
                    alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + e);
                    loading.value = false;
                    return false;
                }
            };

            onMounted(() => fetchData());

            const saveDailyRecords = async () => {
                const promises = [];
                dailyChores.forEach(chore => {
                    const entry = entryData.value[chore.id];
                    if (entry.checked) {
                        promises.push(postData({
                            action: 'add',
                            id: Date.now() + Math.random(),
                            date: inputDate.value,
                            childId: selectedChildId.value,
                            choreId: chore.id,
                            price: entry.price,
                            note: entry.note
                        }));
                    }
                });

                if (promises.length > 0) {
                    await Promise.all(promises);
                    alert("âœ… ä¿å­˜ã—ã¾ã—ãŸï¼");
                    resetEntryData();
                } else { alert("ãŠæ‰‹ä¼ã„ã‚’é¸ã‚“ã§ãã ã•ã„"); }
            };

            const saveMonthlyRecord = async () => {
                if (isMonthlyRegistered.value && !confirm("ä»Šæœˆåˆ†ã¯ã™ã§ã«ã‚ã‚Šã¾ã™ãŒã€ä¸Šæ›¸ãè¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ")) return;
                const success = await postData({
                    action: 'add',
                    id: Date.now() + Math.random(),
                    date: `${inputMonth.value}-01`,
                    childId: selectedChildId.value,
                    choreId: 'ruto_care',
                    price: monthlyData.value.price,
                    note: monthlyData.value.note
                });
                if(success) alert("âœ… æœˆé¡ãŠæ‰‹ä¼ã„ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
            };

            const deleteRecord = async (rec) => {
                if(!confirm(`ã€Œ${rec.date} ã® ${getChoreLabel(rec.choreId)} (Â¥${rec.price})ã€\n\næœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
                loading.value = true;
                await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: 'delete', id: rec.id })
                });
                await fetchData();
                alert("ğŸ—‘ï¸ å‰Šé™¤ã—ã¾ã—ãŸ");
            };

            const getChildName = (id) => children.value.find(c => c.id === id)?.name;
            const getChildColor = (id) => children.value.find(c => c.id === id)?.color;
            const getChoreLabel = (id) => allChores.find(c => c.id === id)?.label;
            const formatMonth = (ym) => `${parseInt(ym.split('-')[1])}æœˆ`;
            const isMonthlyRegistered = computed(() => records.value.some(r => r.childId === selectedChildId.value && r.choreId === 'ruto_care' && r.date.startsWith(inputMonth.value)));
            
            // â˜… æ”¹è‰¯ã—ãŸãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ â˜…
            const filteredRecords = computed(() => {
                let recs = [...records.value];
                recs = recs.filter(r => {
                    const d = new Date(r.date);
                    
                    // å¹´åˆ¥ãƒ¢ãƒ¼ãƒ‰ï¼šé¸æŠã—ãŸå¹´ã¨ä¸€è‡´ã™ã‚‹ã‹ï¼Ÿ
                    if (filterType.value === 'year') {
                        return d.getFullYear() === targetYear.value;
                    }
                    // æœˆåˆ¥ãƒ¢ãƒ¼ãƒ‰ï¼šé¸æŠã—ãŸå¹´ï¼†æœˆã¨ä¸€è‡´ã™ã‚‹ã‹ï¼Ÿ
                    if (filterType.value === 'month') {
                        // JavaScriptã®æœˆã¯0å§‹ã¾ã‚Šãªã®ã§+1ã™ã‚‹
                        return d.getFullYear() === targetYear.value && (d.getMonth() + 1) === targetMonth.value;
                    }
                    return true;
                });
                return recs.sort((a, b) => new Date(b.date) - new Date(a.date));
            });

            const getFilteredTotalAmount = (cid) => filteredRecords.value.filter(r => r.childId === cid).reduce((s, r) => s + r.price, 0);
            const getFilteredTotalCount = (cid) => filteredRecords.value.filter(r => r.childId === cid).length;
            const getBreakdown = (cid) => {
                const map = {};
                filteredRecords.value.filter(r => r.childId === cid).forEach(r => {
                    if (!map[r.choreId]) map[r.choreId] = { choreId: r.choreId, label: getChoreLabel(r.choreId), count: 0, amount: 0 };
                    map[r.choreId].count++; map[r.choreId].amount += r.price;
                });
                return Object.values(map).sort((a, b) => b.amount - a.amount);
            };

            return {
                children, dailyChores, monthlyChores, loading, currentView, selectedChildId, inputDate, entryData, inputMonth, monthlyData, 
                filterType, filterTypes, targetYear, targetMonth, yearList,
                filteredRecords, isMonthlyRegistered, getChildName, getChildColor, getChoreLabel, formatMonth, getFilteredTotalAmount, getFilteredTotalCount, getBreakdown,
                saveDailyRecords, saveMonthlyRecord, deleteRecord, fetchData
            };
        }
    }).mount('#app');
</script>
</body>
</html>
